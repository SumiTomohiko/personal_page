<!DOCTYPE html>
<html>
  <head>
    @include("head.html")@
  </head>
  <body>
    @include("header.html")@
    <h1>@page_title@</h1>
    <section>
      <h1>Description</h1>
      <p>I tryed encription of root directory at FreeBSD. This article describes
      what I did.</p>
    </section>
    <section>
      <h1>Targets</h1>
      <section>
        <h1>PC</h1>
        <p>PC was a laptop of Dell Latitude x300. Its spec is;</p>
        <table>
          <tr><th>CPU</th><td>Intel Pentium M 1.40GHz</td></tr>
          <tr><th>Memory</th><td>640Mbyte</td></tr>
          <tr><th>HDD</th><td>80Gbyte</td></tr>
        </table>
      </section>
      <section><h1>OS</h1><p>OS was FreeBSD 8.2.</p></section>
    </section>
    <section>
      <h1>What I Needed</h1>
      <p>I needed the following tools.</p>
      <ol>
        <li>livefs which is CD-ROM burned with
        FreeBSD-8.2-RELEASE-i386-livefs.iso.</li>
        <li>disc1 which is CD-ROM burned with
        FreeBSD-8.2-RELEASE-i386-disc1.iso.</li>
        <li>Two CD-ROM drives. One was for livefs to boot, second one was for
        installing system with disc1. Two discs were used at same time. But
        disc1 could be non CD-ROM media. For example, a USB memory including
        contents of disc1.</li>
        <li>One USB memory to save log.</li>
      </ol>
    </section>
    <section>
      <h1>Overview</h1>
      <section>
        <h1>Cryptgraphic Subsystem</h1>
        <p>I used geli without master keys. Only a passphrase was given.</p>
      </section>
      <section>
        <h1>Slices and Partitions</h1>
        <p>HDD overall is <code>ad0</code>. I split it into two slices.</p>
        <table>
          <thead><tr><th>Slice</th><th>Size [Mbyte]</th></tr></thead>
          <tbody>
            <tr>
              <td><code>/dev/ad0s1</code></td><td class="numeric">256</td>
            </tr>
            <tr><td><code>/dev/ad0s2</code></td><td>Rest of All</td></tr>
          </tbody>
        </table>
        <p><code>/dev/ad0s1</code> is for boot. This slice was not encrypted,
        and has one partition of UTF2. The partition includes <code>/boot</code>
        directory and <code>/etc/fstab</code>.</p>
        <p>I encrypted <code>/dev/ad0s2</code>. This slice has all partitions
        needed by FreeBSD including swap. Attaching this slice gave a slice of
        <code>/dev/ad0s2.eli</code>. I made the following partitions in this
        slice.</p>
        <table>
          <thead>
            <tr>
              <th>Filesystem</th>
              <th>Type</th>
              <th>Size [byte]</th>
              <th>Mounted on</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>/dev/ad0s2.elia</code></td>
              <td>swap</td>
              <td class="numeric">1.3G</td>
              <td></td>
            </tr>
            <tr>
              <td><code>/dev/ad0s2.elib</code></td>
              <td>UFS2</td>
              <td class="numeric">512M</td>
              <td><code>/</code></td>
            </tr>
            <tr>
              <td><code>/dev/ad0s2.elid</code></td>
              <td>UFS2</td>
              <td class="numeric">256M</td>
              <td><code>/tmp</code></td>
            </tr>
            <tr>
              <td><code>/dev/ad0s2.elie</code></td>
              <td>UFS2</td>
              <td class="numeric">2G</td>
              <td><code>/var</code></td>
            </tr>
            <tr>
              <td><code>/dev/ad0s2.elif</code></td>
              <td>UFS2</td>
              <td>Rest of All (70G)</td>
              <td><code>/usr</code></td>
            </tr>
          </tbody>
        </table>
      </section>
      <section>
        <h1>Logging</h1>
        <p>I logged with @man("script(1)")@ to the USB memory.</p>
      </section>
    </section>
    <section>
      <h1>What I Did</h1>
      <section>
        <h1>Booted from livefs, Run Fixit and Started Logging</h1>
        <p>I turned on my PC with inserting livefs CD-ROM. And selected
        &quot;Fixit&quot; in the menu to see shell.</p>
        <p>I inserted the USB memory and mounted it. And run @man("script(1)")@.
        </p>
      </section>
      <section>
        <h1>Made Slices</h1>
        <p>I added the first slice. <code>da0</code> in output of
        <code>gpart show</code> was the USB memory used for logging. Ignore
        this.</p>
        <pre><code>Fixit# <kbd>gpart create -s mbr ad0</kbd>
ad0 created
        Fixit# <kbd>gpart show</kbd>
=&gt;    32  239840  da0  MBR  (117M)
      32  239840       - free -  (117M)

=&gt;       63  156301425  ad0  MBR  (75G)
         63  156301425       - free -  (75G)

Fixit# gpart add -s 256m -t freebsd ad0
ad0s1 added
Fixit# gpart show
=&gt;    32  239840  da0  MBR  (117M)
      32  239840       - free -  (117M)

=&gt;       63  156301425  ad0  MBR  (75G)
         63     524286    1  freebsd  (256M)
     524349  155777139       - free -  (74G)

</code></pre>
        <p>Second slice was added.</p>
        <pre><code>Fixit# <kbd>gpart add -t freebsd ad0</kbd>
ad0s2 added
Fixit# <kbd>gpart show</kbd>
=&gt;    32  239840  da0  MBR  (117M)
      32  239840       - free -  (117M)

=&gt;       63  156301425  ad0  MBR  (75G)
         63     524286    1  freebsd  (256M)
     524349  155777139    2  freebsd  (74G)

</code></pre>
        <p>The first slice was activated to boot.</p>
        <pre><code>Fixit# <kbd>gpart set -a active -i 1 ad0</kbd>
active set on ad0s1
Fixit# <kbd>gpart show</kbd>
=&gt;    32  239840  da0  MBR  (117M)
      32  239840       - free -  (117M)

=&gt;       63  156301425  ad0  MBR  (75G)
         63     524286    1  freebsd  [active]  (256M)
     524349  155777139    2  freebsd  (74G)

</code></pre>
      </section>
      <section>
        <h1>Encrypted</h1>
        <p>I needed to load geom_eli module.</p>
        <pre><code>Fixit# <kbd>ln -s /dist/lib /lib</kbd>
Fixit# <kbd>ln -s /dist/boot/kernel /boot/modules</kbd>
Fixit# <kbd>kldload geom_eli</kbd>
</code></pre>
        <p>At next I gave a passphrase.</p>
        <pre><code>Fixit# <kbd>geli init -b -B none /dev/ad0s2</kbd>
Enter new passphrase:
Reenter new passphrase:
</code></pre>
        <div class="memo">
          <p>When I did not give <code>-B</code> option at this step, I got;</p>
          <pre><code>Fixit# <kbd>geli init -b /dev/ad0s2</kbd>
Enter new passphrase:
Reenter new passphrase:
geli: Cannot open /var/backups/ad0s2.eli: No such file or directory.
</code></pre>
        </div>
        <p>Attaching <code>ad0s2</code> gave <code>ad0s2.eli</code>.</p>
        <pre><code>Fixit# <kbd>ls /dev/ad0*</kbd>
/dev/ad0	/dev/ad0s1	/dev/ad0s2
Fixit# <kbd>geli attach /dev/ad0s2</kbd>
Enter passphrase:
Fixit# <kbd>ls /dev/ad0*</kbd>
/dev/ad0	/dev/ad0s1	/dev/ad0s2	/dev/ad0s2.eli
</code></pre>
      </section>
      <section>
        <h1>Made Partitions</h1>
        <section>
          <h1>First Slice</h1>
          <p>I made a partition for boot in the first slice.</p>
          <pre><code>Fixit# <kbd>gpart create -s bsd ad0s1</kbd>
ad0s1 created
Fixit# <kbd>gpart show</kbd>
=&gt;    32  239840  da0  MBR  (117M)
      32  239840       - free -  (117M)

=&gt;       63  156301425  ad0  MBR  (75G)
         63     524286    1  freebsd  [active]  (256M)
     524349  155777139    2  freebsd  (74G)

=&gt;     0  524286  ad0s1  BSD  (256M)
       0  524286         - free -  (256M)

Fixit# <kbd>gpart add -t freebsd-ufs ad0s1</kbd>
ad0s1a added
Fixit# <kbd>gpart show</kbd>
=&gt;    32  239840  da0  MBR  (117M)
      32  239840       - free -  (117M)

=&gt;       63  156301425  ad0  MBR  (75G)
         63     524286    1  freebsd  [active]  (256M)
     524349  155777139    2  freebsd  (74G)

=&gt;     0  524286  ad0s1  BSD  (256M)
       0  524286      1  freebsd-ufs  (256M)

</code></pre>
        </section>
        <section>
          <h1>Second Slice</h1>
          <p>I made partitions in the second slice with the same way.</p>
          <pre><code>Fixit# <kbd>gpart create -s bsd ad0s2.eli</kbd>
ad0s2.eli created
Fixit# <kbd>gpart show</kbd>
=&gt;    32  239840  da0  MBR  (117M)
      32  239840       - free -  (117M)

=&gt;       63  156301425  ad0  MBR  (75G)
         63     524286    1  freebsd  [active]  (256M)
     524349  155777139    2  freebsd  (74G)

=&gt;     0  524286  ad0s1  BSD  (256M)
       0  524286      1  freebsd-ufs  (256M)

=&gt;        0  155777138  ad0s2.eli  BSD  (74G)
          0  155777138             - free -  (74G)

Fixit# <kbd>gpart add -t freebsd-swap -s 128m ad0s2.eli</kbd>
ad0s2.elia added
Fixit# <kbd>gpart show</kbd>
=&gt;    32  239840  da0  MBR  (117M)
      32  239840       - free -  (117M)

=&gt;       63  156301425  ad0  MBR  (75G)
         63     524286    1  freebsd  [active]  (256M)
     524349  155777139    2  freebsd  (74G)

=&gt;     0  524286  ad0s1  BSD  (256M)
       0  524286      1  freebsd-ufs  (256M)

=&gt;        0  155777138  ad0s2.eli  BSD  (74G)
          0    2621440          1  freebsd-swap  (1.3G)
    2621440  153155698             - free -  (73G)

Fixit# <kbd>gpart add -t freebsd-ufs -s 128m ad0s2.eli</kbd>
ad0s2.elib added
Fixit# <kbd>gpart show</kbd>
=&gt;    32  239840  da0  MBR  (117M)
      32  239840       - free -  (117M)

=&gt;       63  156301425  ad0  MBR  (75G)
         63     524286    1  freebsd  [active]  (256M)
     524349  155777139    2  freebsd  (74G)

=&gt;     0  524286  ad0s1  BSD  (256M)
       0  524286      1  freebsd-ufs  (256M)

=&gt;        0  155777138  ad0s2.eli  BSD  (74G)
          0    2621440          1  freebsd-swap  (1.3G)
    2621440     262144          2  freebsd-ufs  (128M)
    2883584  152893554             - free -  (73G)

Fixit# <kbd>gpart add -t freebsd-ufs -s 256m ad0s2.eli</kbd>
ad0s2.elid added
Fixit# <kbd>gpart show</kbd>
=&gt;    32  239840  da0  MBR  (117M)
      32  239840       - free -  (117M)

=&gt;       63  156301425  ad0  MBR  (75G)
         63     524286    1  freebsd  [active]  (256M)
     524349  155777139    2  freebsd  (74G)

=&gt;     0  524286  ad0s1  BSD  (256M)
       0  524286      1  freebsd-ufs  (256M)

=&gt;        0  155777138  ad0s2.eli  BSD  (74G)
          0    2621440          1  freebsd-swap  (1.3G)
    2621440     262144          2  freebsd-ufs  (128M)
    2883584     524288          4  freebsd-ufs  (256M)
    3407872  152369266             - free -  (73G)

Fixit# <kbd>gpart add -t freebsd-ufs -s 2g ad0s2.eli</kbd>
ad0s2.elie added
Fixit# <kbd>gpart show</kbd>
=&gt;    32  239840  da0  MBR  (117M)
      32  239840       - free -  (117M)

=&gt;       63  156301425  ad0  MBR  (75G)
         63     524286    1  freebsd  [active]  (256M)
     524349  155777139    2  freebsd  (74G)

=&gt;     0  524286  ad0s1  BSD  (256M)
       0  524286      1  freebsd-ufs  (256M)

=&gt;        0  155777138  ad0s2.eli  BSD  (74G)
          0    2621440          1  freebsd-swap  (1.3G)
    2621440     262144          2  freebsd-ufs  (128M)
    2883584     524288          4  freebsd-ufs  (256M)
    3407872    4194304          5  freebsd-ufs  (2.0G)
    7602176  148174962             - free -  (71G)

Fixit# <kbd>gpart add -t freebsd-ufs ad0s2.eli</kbd>
ad0s2.elif added
Fixit# <kbd>gpart show</kbd>
=&gt;    32  239840  da0  MBR  (117M)
      32  239840       - free -  (117M)

=&gt;       63  156301425  ad0  MBR  (75G)
         63     524286    1  freebsd  [active]  (256M)
     524349  155777139    2  freebsd  (74G)

=&gt;     0  524286  ad0s1  BSD  (256M)
       0  524286      1  freebsd-ufs  (256M)

=&gt;        0  155777138  ad0s2.eli  BSD  (74G)
          0    2621440          1  freebsd-swap  (1.3G)
    2621440     262144          2  freebsd-ufs  (128M)
    2883584     524288          4  freebsd-ufs  (256M)
    3407872    4194304          5  freebsd-ufs  (2.0G)
    7602176  148174962          6  freebsd-ufs  (71G)

</code></pre>
      </section>
      <section>
        <h1>Installed System</h1>
      </section>
      <section>
        <h1>Rebooted and Done</h1>
      </section>
    </section>
    <section>
      <h1>Troubles I Had</h1>
      <section>
        <h1><code>fdisk -BI /dev/ad0</code> Didn't Work</h1>
        <p>Use <code>gpart(8)</code>.</p>
      </section>
      <section>
        <h1>Sanitising</h1>
      </section>
      <section>
        <h1>Installing from sysinstall</h1>
      </section>
    </section>
    <section>
      <h1>References</h1>
      <ul>
        <li><a href="https://catbull.com/wiki/index.php/FreeBSD_Encrypted_Root">
        FreeBSD Encrypted Root - catbull multimedia wiki</a></li>
      </ul>
    </section>
  </body>
</html>
<!--
vim: tabstop=2 shiftwidth=2 expandtab softtabstop=2
-->
